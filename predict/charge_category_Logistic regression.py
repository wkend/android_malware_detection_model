#!/usr/bin/env python 3.7
# -*- coding: utf-8 -*-
# @Time    : 2019/5/9 15:30
# @Author  : wkend
# @File    : charge_category_Logistic regression.py
# @Software: PyCharm

from sklearn.linear_model import LogisticRegression
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from predict.get_DataSets import get_dataSets


def charge_category_LogisticRegression(X, y):
    """利用数据集进行分类"""
    X = np.array(X, dtype=float)
    y = np.array(y)

    # 分离数据集，得到训练集和测试集
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=66)

    # 对训练、测试数据进行归一化处理
    standardScaler = StandardScaler()
    standardScaler.fit(X_train)
    X_train = standardScaler.transform(X_train)  # 对训练数据集进行归一化
    X_test_standrad = standardScaler.transform(X_test)  # 对测试数据进行归一化

    # 使用归一化的数据进行分类
    log_reg = LogisticRegression()
    log_reg.fit(X_train, y_train)

    y_predict = log_reg.predict(X_test_standrad)  # 预测结果向量
    score = log_reg.score(X_test_standrad, y_test)  # 预测准确率
    print('预测准确率：' + str(score))
    return y_test, y_predict


def TN(y_true, y_predict):
    """
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回TN值
    """
    assert len(y_true) == len(y_predict)
    return np.sum((y_true == 0) & (y_predict == 0))


def FP(y_true, y_predict):
    """
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回FP值
    """
    assert len(y_true) == len(y_predict)
    return np.sum((y_true == 0) & (y_predict == 1))


def FN(y_true, y_predict):
    """
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回FN值
    """
    assert len(y_true) == len(y_predict)
    return np.sum((y_true == 1) & (y_predict == 0))


def TP(y_true, y_predict):
    """
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回TP值
    """
    assert len(y_true) == len(y_predict)
    return np.sum((y_true == 1) & (y_predict == 1))


def confusion_matrix(y_true, y_predict):
    """
        求混淆矩阵
        :param y_true:样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict:样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回混淆矩阵
    """
    return np.array([
        [TN(y_true, y_predict), FP(y_true, y_predict)],
        [FN(y_true, y_predict), TP(y_true, y_predict)],
    ])


def accuracy_score(y_true, y_predict):
    """
    求准确率
    :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
    :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
    :return: 返回预测结果的准确率
    """
    assert len(y_true) == len(y_predict)
    return sum(y_true == y_predict) / len(y_true)


def precision_score(y_true, y_predict):
    """
        求精准率
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回预测结果的精准率
    """
    tp = TN(y_true, y_predict)
    fp = TN(y_true, y_predict)
    try:
        return tp / (tp + fp)
    except:
        return 0.0


def recall_score(y_true, y_predict):
    """
        求精准率
        :param y_true: 样本真实值，为0表示为恶意软件，为1表示为良性软件
        :param y_predict: 样本预测值，为0表示预测为恶意软件，为1表示预测为良性软件
        :return: 返回预测结果的精准率
    """
    tp = TN(y_true, y_predict)
    fn = FN(y_true, y_predict)
    try:
        return tp / (tp + fn)
    except:
        return 0.0


def f1_score(precision,recall):
    """
    求精准率和召回率的调和平均值
    :param precision: 精准率
    :param recall: 召回率
    :return: 精准率和召回率的调和平均值
    """
    try:
        return 2 * precision * recall / (precision + recall)
    except:
        return 0.0


if __name__ == '__main__':
    malware_path = 'G:/毕设/软件样本库/恶意样本/decompile'
    benign_path = 'G:/毕设/软件样本库/良性样本/decompile'
    # path = 'E:/毕设/软件样本库/恶意软件/test'

    malware_dataSets = get_dataSets(malware_path)
    # print(len(malware_dataSets)) # 1260

    benign_dataSets = get_dataSets(benign_path)
    # print(len(benign_dataSets)) # 1184

    malware_dataSets.extend(benign_dataSets)

    dataSets = malware_dataSets
    # print(dataSets)

    category = [0] * 1260 + [1] * 1184
    # print(category)

    y_test, y_predict = charge_category_LogisticRegression(dataSets, category)
    # print(y_test)
    # print(y_predict)

    confusion_matrix = confusion_matrix(y_test, y_predict)
    print(confusion_matrix)

    accuracy_score = accuracy_score(y_test, y_predict)
    print('逻辑回归准确率：' + str(accuracy_score))

    precision_score = precision_score(y_test, y_predict)
    print('逻辑回归精准率：' + str(precision_score))

    recall_score = recall_score(y_test, y_predict)
    print('逻辑回归召回率：' + str(recall_score))

    f1_score = f1_score(precision_score, recall_score)
    print('逻辑回归F1 Score：' + str(recall_score))

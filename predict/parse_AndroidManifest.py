#!/usr/bin/env python 3.7
# -*- coding: utf-8 -*-
# @Time    : 2019/5/8 14:12
# @Author  : wkend
# @File    : parse_AndroidManifest.py
# @Software: PyCharm

from xml.etree.ElementTree import parse

dangerous_permission = [
    'READ_CALENDAR', 'WRITE_CALENDAR',
    'READ_CALL_LOG', 'WRITE_CALL_LOG', 'PROCESS_OUTGOING_CALLS',
    'CAMERA',
    'READ_CONTACTS', 'WRITE_CONTACTS', 'GET_ACCOUNTS',
    'ACCESS_FINE_LOCATION', 'ACCESS_COARSE_LOCATION',
    'RECORD_AUDIO',
    'READ_PHONE_STATE', 'READ_PHONE_NUMBERS', 'CALL_PHONE', 'ANSWER_PHONE_CALLS', 'ADD_VOICEMAIL', 'USE_SIP',
    'BODY_SENSORS',
    'SEND_SMS', 'RECEIVE_SMS', 'READ_SMS', 'RECEIVE_WAP_PUSH', 'RECEIVE_MMS',
    'READ_EXTERNAL_STORAGE', 'WRITE_EXTERNAL_STORAGE'
]


def get_elementTree(file_path):
    """
    把xml文件解析为xml节点形式
    :param file_path: xml文件路径
    :return:
    """
    with open(file_path, encoding='utf-8') as f:
        try:
            doc = parse(f)
        except Exception:
            print('Error: ' + file_path)
        else:
            return doc


def get_actList(doc):
    """
    读取全部activity组件名
    :param doc: 节点形式的xml文件
    :return:
    """
    node_list = doc.findall('application/activity')  # 获取全部activity节点
    act_list = []
    for node in node_list:
        act_list.append(node.get('{http://schemas.android.com/apk/res/android}name'))
    return len(act_list)


def get_serList(doc):
    """
    读取全部service组件名
    :param doc: 节点形式的xml文件
    :return:
    """
    node_list = doc.findall('application/service')  # 获取全部activity节点
    ser_list = []
    for node in node_list:
        ser_list.append(node.get('{http://schemas.android.com/apk/res/android}name'))
    return len(ser_list)


def get_receList(doc):
    """
    读取全部receiver组件名
    :param doc: 节点形式的xml文件
    :return:
    """
    node_list = doc.findall('application/receiver')  # 获取全部activity节点
    rece_list = []
    for node in node_list:
        rece_list.append(node.get('{http://schemas.android.com/apk/res/android}name'))
    return len(rece_list)


def get_provList(doc):
    """
    读取全部provider组件名
    :param doc: 节点形式的xml文件
    :return:
    """
    node_list = doc.findall('application/provider')  # 获取全部activity节点
    prov_list = []
    for node in node_list:
        prov_list.append(node.get('{http://schemas.android.com/apk/res/android}name'))
    return len(prov_list)


def get_permission(doc):
    """提取所有权限"""
    node_list = doc.findall('uses-permission')  # 获取全部activity节点
    permission_list = []
    X_permission = [0] * 26
    for node in node_list:
        try:
            permission = node.get('{http://schemas.android.com/apk/res/android}name').split('.')[-1]
            permission_list.append(permission)
            if permission in dangerous_permission:
                X_permission[dangerous_permission.index(permission)] = 1
        except Exception:
            continue
    return permission_list, X_permission
